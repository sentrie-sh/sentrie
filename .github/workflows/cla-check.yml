name: CLA check

on:
  pull_request:
    branches: ["main"]
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-bypass:
    name: Check bypass
    runs-on: ubuntu-latest
    outputs:
      bypass: ${{ steps.set_bypass.outputs.bypass }}
    steps:
      - name: Short-circuit for bots
        id: skip_bots
        shell: bash
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          set -euo pipefail

          # Hardcoded list of bots that bypass CLA
          BOTS=(
            "dependabot[bot]"
            "renovate[bot]"
          )

          skip="false"
          for bot in "${BOTS[@]}"; do
            if [[ "${PR_AUTHOR}" == "${bot}" ]]; then
              skip="true"
              echo "Skipping CLA check for bot: ${PR_AUTHOR}"
              break
            fi
          done

          echo "skip=${skip}" >> "${GITHUB_OUTPUT}"

      - name: Checkout base (main) branch
        if: steps.skip_bots.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Skip CLA check for maintainers
        id: skip_maintainers
        if: steps.skip_bots.outputs.skip != 'true'
        shell: bash
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          set -euo pipefail

          skip="false"

          if [[ -f "MAINTAINERS" ]]; then
            # Read maintainers from file, ignoring comments and empty lines
            while IFS= read -r line || [[ -n "${line}" ]]; do
              # Skip comments and empty lines
              [[ "${line}" =~ ^#.*$ ]] && continue
              [[ -z "${line}" ]] && continue
              # Trim whitespace
              line="${line// /}"
              if [[ "${PR_AUTHOR}" == "${line}" ]]; then
                skip="true"
                echo "Skipping CLA check for maintainer: ${PR_AUTHOR}"
                break
              fi
            done < "MAINTAINERS"
          fi

          echo "skip=${skip}" >> "${GITHUB_OUTPUT}"

      - name: Set bypass status
        id: set_bypass
        shell: bash
        run: |
          if [[ "${{ steps.skip_bots.outputs.skip }}" == "true" ]] || \
             [[ "${{ steps.skip_maintainers.outputs.skip }}" == "true" ]]; then
            echo "bypass=true" >> "${GITHUB_OUTPUT}"
            echo "CLA check bypassed."
          else
            echo "bypass=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Exit early for bypassed authors
        if: steps.set_bypass.outputs.bypass == 'true'
        shell: bash
        run: |
          echo "Author is in CLA bypass list. Skipping CLA checks."

  validate:
    name: Validate CLA
    needs: check-bypass
    if: needs.check-bypass.outputs.bypass != 'true'
    uses: ./.github/workflows/cla-validate.yml
    with:
      pr_author: ${{ github.event.pull_request.user.login }}
      pr_number: ${{ github.event.pull_request.number }}
      head_sha: ${{ github.event.pull_request.head.sha }}
      base_ref: ${{ github.event.pull_request.base.ref }}
