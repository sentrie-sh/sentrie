name: Third Party Dependency Policy

on:
  pull_request:
    branches: ["main"]
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-policy:
    runs-on: ubuntu-latest

    env:
      REPO: ${{ github.repository }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Detect dependency file changes
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking changed files for PR #${PR_NUMBER}"

          FILES=$(gh api "repos/${REPO}/pulls/${PR_NUMBER}/files" --paginate --jq '.[].filename')
          echo "Changed files:"
          echo "${FILES}"

          dep_changed="false"

          # Extend this list as needed (package.json, pnpm-lock.yaml, etc)
          if grep -qx "go.mod" <<< "${FILES}" || grep -qx "go.sum" <<< "${FILES}"; then
            dep_changed="true"
          fi

          echo "dep_changed=${dep_changed}" >> "${GITHUB_OUTPUT}"
          echo "Dependency files changed: ${dep_changed}"

      - name: Skip if dependencies did not change
        if: steps.detect.outputs.dep_changed == 'false'
        shell: bash
        run: |
          echo "No dependency manifest changes detected. Skipping dependency policy checks."

      - name: Ensure PR has Dependencies section filled
        id: deps_section
        if: steps.detect.outputs.dep_changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          echo "Fetching PR body for #${PR_NUMBER}"

          BODY=$(gh api "repos/${REPO}/pulls/${PR_NUMBER}" --jq '.body')

          echo "PR body:"
          echo "---------------------------------"
          echo "${BODY}"
          echo "---------------------------------"

          # Very simple heuristic: section header plus something other than '- None'
          has_section="false"
          if grep -q "## Dependencies" <<< "${BODY}"; then
            has_section="true"
          fi

          has_content="false"
          if grep -q "## Dependencies" <<< "${BODY}"; then
            # Get everything after the Dependencies header
            after=$(awk '/^## Dependencies/{flag=1;next}/^## /{flag=0}flag' <<< "${BODY}" || true)
            # Check if the block is not just '- None'
            trimmed=$(echo "${after}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' || true)
            if [[ -n "${trimmed}" && "${trimmed}" != "- None" ]]; then
              has_content="true"
            fi
          fi

          echo "has_section=${has_section}" >> "${GITHUB_OUTPUT}"
          echo "has_content=${has_content}" >> "${GITHUB_OUTPUT}"
          echo "Dependencies section present: ${has_section}, content provided: ${has_content}"

      - name: Enforce Dependencies section
        if: steps.detect.outputs.dep_changed == 'true' && steps.deps_section.outputs.has_content != 'true'
        shell: bash
        run: |
          set -euo pipefail

          echo "Dependency files changed but PR does not contain a filled Dependencies section."
          echo "Please describe the new/changed dependencies and their licenses under '## Dependencies'."
          exit 1

      - name: Dependency Review
        if: steps.detect.outputs.dep_changed == 'true'
        uses: actions/dependency-review-action@v4
        with:
          # Fail on any vulnerability severity (low, moderate, high, critical)
          fail-on-severity: low
          # Allow only permissive licenses per THIRD_PARTY_POLICY.md
          # Permissive licenses: Apache-2.0, MIT, BSD-2-Clause, BSD-3-Clause, ISC, CC0-1.0
          allow-licenses: Apache-2.0, MIT, BSD-2-Clause, BSD-3-Clause, ISC, CC0-1.0
          # Check vulnerabilities in runtime dependencies
          fail-on-scopes: runtime
          # Enable license checking
          license-check: true
          # Enable vulnerability checking
          vulnerability-check: true
          # Comment summary on failure
          comment-summary-in-pr: on-failure

      - name: Set up Go
        if: steps.detect.outputs.dep_changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Install go-licenses
        if: steps.detect.outputs.dep_changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          echo "Installing go-licenses..."
          go install github.com/google/go-licenses@latest
          echo "$(go env GOPATH)/bin" >> "${GITHUB_PATH}"

      - name: Run go-licenses report (detailed license scan)
        if: steps.detect.outputs.dep_changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          echo "Running go-licenses report ./..."
          echo "This provides detailed license information for all dependencies including transitive dependencies."
          echo "=========================================="

          REPORT=$(go-licenses report ./... 2>&1 || true)

          echo "${REPORT}"
          echo "=========================================="

          # Check for disallowed licenses and report them (but don't fail - dependency-review-action already enforces)
          disallowed_lines=""
          while IFS= read -r line; do
            # Skip empty lines and warnings
            [[ -z "${line}" ]] && continue
            [[ "${line}" =~ ^W[0-9] ]] && continue

            module=$(echo "${line}" | awk -F',' '{print $1}')
            license=$(echo "${line}" | awk -F',' '{print $3}')

            # Normalize whitespace
            license=$(echo "${license}" | xargs)

            # Check license against our denylist
            # Match GPL variants (GPL, GPL-2.0, GPL-3.0, etc.), LGPL, AGPL, EPL, MPL
            case "${license}" in
              *GPL*|*LGPL*|*AGPL*|*EPL*|*MPL*)
                disallowed_lines+="${module},${license}"$'\n'
                ;;
            esac
          done <<< "${REPORT}"

          if [[ -n "${disallowed_lines}" ]]; then
            echo ""
            echo "⚠️  WARNING: go-licenses detected potentially disallowed licenses:"
            echo "---------------------------------"
            echo "${disallowed_lines}"
            echo "---------------------------------"
            echo "Note: dependency-review-action should have already blocked these."
            echo "This is for informational purposes only."
          else
            echo ""
            echo "✅ go-licenses scan: No disallowed licenses detected in detailed scan."
          fi
